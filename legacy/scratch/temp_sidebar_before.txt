'use client'

import { usePathname, useRouter } from 'next/navigation'
import { useEffect, useMemo, useState } from 'react'
import { useUser, useClerk } from '@clerk/nextjs'
import { postEvent } from '@/lib/telemetry'
import { Settings, LogOut } from 'lucide-react'

type Membership = { id:number; project_id:number; role?:string; hours_planned?:number; active:boolean }

interface NavItem {
  name: string
  href: string
}

export default function StudentSidebar() {
  const pathname = usePathname()
  const router = useRouter()
  const { user } = useUser()
  const { signOut } = useClerk()
  const [hasActiveProject, setHasActiveProject] = useState(false)
  const [showProfileMenu, setShowProfileMenu] = useState(false)
  const isSignedIn = !!user

  useEffect(() => {
    let ignore = false
    const load = async () => {
      try {
        const email = user?.primaryEmailAddress?.emailAddress
        if (!email) return
        const res = await fetch('/api/public/memberships/mine', {
          headers: email ? { 'X-Student-Email': email } : undefined,
        })
        if (!res.ok) return
        const data = (await res.json()) as Membership[]
        if (!ignore) setHasActiveProject(Array.isArray(data) && data.some(m => !!m.active))
      } catch {}
    }
    load()
    return () => { ignore = true }
  }, [user?.primaryEmailAddress?.emailAddress])

  const items = useMemo(() => {
    const baseItems: NavItem[] = [
      { name: 'Projects', href: '/projects' },
    ]
    // Applications moved to modal on Projects page (no left-nav entry)
    if (hasActiveProject) baseItems.push({ name: 'My Projects', href: '/my-projects' })
    baseItems.push({ name: 'Learning Center', href: '/learning' })
    return baseItems
  }, [hasActiveProject])

  const isActive = (href: string) => pathname === href || pathname.startsWith(href + '/')

  // Parse name to exclude middle names
  // Sometimes Google OAuth puts full name in firstName field
  const rawFirstName = user?.firstName || ''
  const rawLastName = user?.lastName || ''
  
  let displayFirstName = ''
  let displayLastName = ''
  
  // Check if firstName contains multiple words (Google sometimes puts full name there)
  const firstNameParts = rawFirstName.trim().split(/\s+/)
  if (firstNameParts.length > 1 && !rawLastName) {
    // firstName has multiple parts and no lastName - parse it
    displayFirstName = firstNameParts[0]
    displayLastName = firstNameParts[firstNameParts.length - 1]
  } else if (rawFirstName && rawLastName) {
    // We have both - use only the first word of firstName
    displayFirstName = firstNameParts[0]
    displayLastName = rawLastName.trim().split(/\s+/)[0] // Also take first word of lastName in case it has middle
  } else if (user?.fullName) {
    // Fall back to parsing fullName
    const nameParts = user.fullName.trim().split(/\s+/)
    if (nameParts.length >= 2) {
      displayFirstName = nameParts[0]
      displayLastName = nameParts[nameParts.length - 1]
    } else if (nameParts.length === 1) {
      displayFirstName = nameParts[0]
    }
  } else {
    // Use whatever we have
    displayFirstName = firstNameParts[0] || ''
    displayLastName = rawLastName
  }
  
  // Build display name - first and last only, no middle names
  const userName = (displayFirstName && displayLastName) 
    ? `${displayFirstName} ${displayLastName}`
    : displayFirstName || user?.primaryEmailAddress?.emailAddress || 'Student'
  
  // Get initials from first and last name only
  const userInitials = (displayFirstName && displayLastName)
    ? `${displayFirstName[0]}${displayLastName[0]}`.toUpperCase()
    : displayFirstName 
      ? displayFirstName[0].toUpperCase()
      : 'S'

  return (
    <div className="w-60 bg-card border-r border-border flex flex-col h-screen fixed left-0 top-0">
      {/* Brand */}
      <div className="h-16 flex items-center px-6 border-b border-border flex-shrink-0">
        <h2 className="text-3xl font-bold text-foreground tracking-tight select-none">NGI Capital</h2>
      </div>

      {/* Navigation */}
      <nav className="flex-1 px-4 py-4 space-y-2 overflow-y-auto">
        {items.map((item) => (
          <button
            key={item.name}
            onClick={() => {
              try { postEvent('nav_click', { route: item.href, position: 'sidebar' }) } catch {}
              router.push(item.href)
            }}
            aria-current={isActive(item.href) ? 'page' : undefined}
            className={`
              w-full flex items-center px-4 py-2.5 text-lg font-medium rounded-xl transition-colors
              ${isActive(item.href)
                ? 'bg-blue-600 text-white shadow-sm'
                : 'text-foreground hover:bg-muted'}
            `}
          >
            <span className="truncate text-left">{item.name}</span>
          </button>
        ))}
      </nav>

      {/* User Profile Section - fixed at bottom */}
      <div className="border-t border-border p-4 relative flex-shrink-0">
        <button
          onClick={() => setShowProfileMenu((v) => !v)}
          className="w-full flex items-center gap-3 text-left hover:bg-muted p-3 rounded-xl transition-colors"
          aria-haspopup="menu"
          aria-expanded={showProfileMenu}
        >
          <div className="h-10 w-10 rounded-full bg-blue-600 flex items-center justify-center flex-shrink-0">
            <span className="text-white text-base font-semibold">
              {userInitials}
            </span>
          </div>
          <div className="flex-1 min-w-0">
            <p className="text-base font-medium text-foreground truncate">
              {userName}
            </p>
          </div>
        </button>

        {showProfileMenu && (
          <div className="absolute bottom-16 left-4 right-4 bg-card border border-border rounded-xl shadow-lg z-50">
            <div className="py-2">
              <button
                onClick={() => { setShowProfileMenu(false); router.push('/settings'); }}
                className="w-full px-4 py-2 text-base text-foreground hover:bg-muted text-left flex items-center gap-2"
                role="menuitem"
              >
                <Settings className="h-4 w-4" />
                Settings
              </button>
              <button
                onClick={() => {
                  setShowProfileMenu(false)
                  signOut({ redirectUrl: '/' })
                }}
                className="w-full px-4 py-2 text-base text-foreground hover:bg-muted text-left flex items-center gap-2"
                role="menuitem"
              >
                <LogOut className="h-4 w-4" />
                Sign Out
              </button>
            </div>
          </div>
        )}

        {showProfileMenu && (
          <div
            className="fixed inset-0 z-40"
            onClick={() => setShowProfileMenu(false)}
            aria-hidden="true"
          />
        )}
      </div>
    </div>
  )
}

